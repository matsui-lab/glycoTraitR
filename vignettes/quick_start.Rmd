---
title: "glycoTraitR Quick Start"
author: "Bingyuan Zhang"
date: "`r BiocStyle::doc_date()`"
package: "`r BiocStyle::pkg_ver('glycoTraitR')`"
abstract: >
  glycoTraitR is designed for users who want to go beyond simple differential analysis, extracting, summarizing, and analyzing glycan structural traits from GPSM data generated by pGlyco3 or Glyco-Decipher.
output:
  BiocStyle::html_document:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{glycoTraitR Quick Start}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(glycoTraitR)

knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction

glycoTraitR is designed for users who want to go beyond simple differential analysis, extracting, summarizing, and analyzing glycan structural traits from GPSM data generated by **pGlyco3** or **Glyco-Decipher**.

It provides a streamlined workflow for:

-   parsing WURCS 2.0 and pGlyco3 glycan strings
-   computing composition & structural traits
-   summarizing glycan–PSM trait matrices at site/protein level (`SummarizedExperiment`)
-   performing differential trait analysis and visualizing trait changes

## Installation
```{r, eval=FALSE}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("matsui-lab/glycoTraitR")
```

# Quick Start

The example uses publicly available pGlyco3 GPSM data hosted on **Zenodo**.

## 1. Load example data

```{r}
# The following is an example file from Zenodo
# url <- "https://zenodo.org/records/17756830/files/pGlycoDB-GP-FDR-Pro-Quant-Site.txt?download=1"
# download.file(url, "pGlyco3_GPSM.txt", mode = "wb")
# gpsm <- read_pGlyco3_gpsm("pGlyco3_GPSM.txt")

# meta_url <- "https://zenodo.org/records/17759790/files/meta_mcp_2022_100433.rds?download=1"
# download.file(meta_url, "meta_example.rds", mode = "wb")
# meta <- readRDS("meta_example.rds")

# The following is a smaller toy example files from package
path <- system.file("extdata", "pGlyco3_gpsm_toyexample.txt", package = "glycoTraitR")
gpsm_toyexample <- read_pGlyco3_gpsm(path)
data("meta_toyexample")
```


## 2. Build glycan trait matrices
```{r}
trait_se <- build_trait_se(
  gpsm_toyexample,
  from = "pGlyco3",
  motifs = NULL,
  level = "protein",
  meta = meta_toyexample
)
```

## 3. Differential analysis
```{r}
changed_traits <- analyze_trait_changes(
  trait_se     = trait_se,
  group_col    = "Diagnosis",
  group_levels = c("Normal", "Symptomatic"),
  min_psm      = 20
)
head(changed_traits)
```

## 4. Trait distribution visualization
```{r}
p <- plot_trait_distribution(
  trait_se     = trait_se,
  group_col    = "Diagnosis",
  group_levels = c("Normal", "Symptomatic"),
  trait_name   = "Hexose",
  feature      = "MOG"
)

p$p_hist
p$p_box
```


# Define Your Own Glycan Motifs

```{r message=FALSE}
library(glycoTraitR)
library(dplyr)
library(igraph)
```

Next we demonstrate how to define the glycan motifs of users' own interests. Users can detect these motif occurrences within glycan structures using *glycoTraitR*.

We will: 1. Parse glycan structures into graph trees 2. Visualize full glycans & motifs 3. Perform **subgraph isomorphism** matching using *igraph* functions 4. Count occurrences of motif patterns

-----

## 1. Parse and plot glycan trees

Suppose we have a vector of glycan structures.
```{r}
# Example: parsed glycan trees from existing GPSM data
path <- system.file("extdata", "pGlyco3_gpsm_toyexample.txt", package = "glycoTraitR")
gpsm_toyexample <- read_pGlyco3_gpsm(path)
data("meta_toyexample")
glycans <- lapply(gpsm_toyexample$GlycanStructure, glycoTraitR:::pGlyco3_to_tree)
```

We use the function `build_glycan_igraph()` to visualize an exxample of glycan structure.
```{r}
# visualize example structures
glycans[[1]] %>%
  glycoTraitR::build_glycan_igraph() %>%
  plot_glycan_tree()
```

------------------------------------------------------------------------

## 2. A Simple User Motif (Example 1)

Here we define a **linear trisaccharide motif**:

-   H — H — H
-   Edges: `"a-b"`, `"b-c"`

```{r}
#### Example 1 ####
# (1) Select a glycan from pGlyco3 data
tree_full <- glycans[[24]]
g_full <- glycoTraitR::build_glycan_igraph(tree_full)

# (2) Define motif manually
motif <- list(
  node = c("H", "H", "H"),
  edge = c("a-b", "b-c")
)
g_motif <- glycoTraitR::build_glycan_igraph(motif)

# (3) Perform subgraph matching
n_match <- count_subgraph_isomorphisms(
  g_motif, g_full,
  method = "vf2",
  vertex.color1 = factor(V(g_full)$type),
  vertex.color2 = factor(V(g_motif)$type)
)

# (4) Visualize
par(mfrow = c(1, 2))
plot_glycan_tree(g_motif)
plot_glycan_tree(g_full)
print(paste(n_match, "motif(s) found in the glycan"))
```

------------------------------------------------------------------------

## 3. Motif Containing Fucose (Example 2)

This example defines a **branched motif** containing Fucose:

```{r}
#### Example 2 ####
# (1) Select a glycan
tree_full <- glycans[[1]]
g_full <- glycoTraitR::build_glycan_igraph(tree_full)

# (2) Symbolic motif definition
motif <- list(
  node = c("H", "N", "F"),
  edge = c("a-b", "b-c")
)
g_motif <- glycoTraitR::build_glycan_igraph(motif)

# (3) Subgraph matching
n_match <- igraph::count_subgraph_isomorphisms(
  g_motif, g_full,
  method = "vf2",
  vertex.color1 = factor(V(g_full)$type),
  vertex.color2 = factor(V(g_motif)$type)
)

# (4) Visualize motif vs. full glycan
par(mfrow = c(1, 2))
plot_glycan_tree(g_motif)
plot_glycan_tree(g_full)
print(paste(n_match, "motif(s) found in the glycan"))
```

------------------------------------------------------------------------

## 4. Integrating Motifs with glycoTraitR (for Trait Computation)

You can define multiple motifs at once:

```{r}
user_motifs <- list(
  LinearH3 = list(
    node = c("H", "H", "H"),
    edge = c("a-b", "b-c")
  ),
  FucBranch = list(
    node = c("H", "N", "F"),
    edge = c("a-b", "b-c")
  )
)
```

Then directly pass them into `build_trait_se()`:

```{r}
trait_se <- build_trait_se(
  gpsm_toyexample,
  from = "pGlyco3",
  motifs = user_motifs,
  level = "protein",
  meta = meta_toyexample
)
SummarizedExperiment::assayNames(trait_se)
```

Your motif counts will automatically appear as **additional glycan traits** in the trait matrices.

------------------------------------------------------------------------

## Conclusion

We have demonstrated how to:

-   Parse glycans into trees
-   Visualize glycan topology
-   Define custom motif structures
-   Apply subgraph isomorphism to detect motif occurrences
-   Integrate motifs into the glycan trait workflow

You can now construct your own biologically meaningful glycan motifs and include them directly in *glycoTraitR* analyses.

```{r session-info, echo=FALSE}
sessionInfo()
```

